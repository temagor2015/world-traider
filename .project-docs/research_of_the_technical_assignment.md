# Исследование технического задания

[Ссылка на исходник технического задания](https://github.com/systemeio/test-for-candidates)

## Результаты исследования технического задания

1. Явное усложнение бизнес логики точек доступов из-за поля "taxNumber" - избыточно, нет необходимости.
2. Сомнительные ответы приложению клиента в части достаточности информации.
3. Не понятно будет ли расширяться система новыми валютами.
4. Отсутствует описание реакции системы на пограничные значения в части выбора процессора оплат. Это должен определить
   представитель бизнеса, а не разработчик.

### Описание точек доступов, их структуры и основных требований

Текс задания состоит из требований и утверждений. Любое утверждение или требование должно быть подвергнуто сомнению со
стороны разработчика с целью выявления проблемной области и минимальных требований, решающих проблему.

---

```text
Написать Symfony REST приложение для расчета цены продукта и проведения оплаты
```

* Symfony - ограничение выбора инструмента разработки
* REST - важное уточнение, накладывающее определённые ограничения на архитектурный подход разрабатываемого функционала.

---

```text
Необходимо написать 2 эндпоинта:

    POST: для расчёта цены (/calculate-price)
    POST: для выполнения покупки (/purchase)
```

Требование подсвечивает две проблемы:

1. Приложение не может рассчитать цену товара
2. Приложение не может выполнить покупку товара

---

```text
POST /calculate-price
{
    "product": 1,
    "taxNumber": "DE123456789",
    "couponCode": "D15"
}

POST /purchase
{
    "product": 1,
    "taxNumber": "IT12345678900",
    "couponCode": "D15",
    "paymentProcessor": "paypal"
}
```

Уточнение структуры запроса влияет на определение проблемной области:

1. Приложение не может рассчитать цену товара используя входящие данные точки доступа
2. Приложение не может выполнить покупку товара используя входящие данные точки доступа

---

```text
При успешном выполнении запроса вернуть HTTP ответ с кодом 200.
```

Уточнение структуры ответа при успешном выполнении всех этапов точки доступа влияет на определение проблемной области:

1. Приложение не может рассчитать цену товара используя входящие данные точки доступа
2. Приложение не может выполнить покупку товара используя входящие данные точки доступа
3. Приложение не может вернуть клиенту ответ об успешном выполнении запроса в необходимом формате

---

```text
При неверных входных данных или ошибках оплаты вернуть HTTP ответ с кодом 400 и json объект с ошибками.
```

Уточнение реакций приложения на ошибки влияет на определение проблемной области:

1. Приложение не может рассчитать цену товара используя входящие данные точки доступа
2. Приложение не может выполнить покупку товара используя входящие данные точки доступа
3. Приложение не может вернуть клиенту ответ об успешном выполнении запроса в необходимом формате
4. Приложение не может вернуть клиенту ответ об ошибке в процессе выполнения запроса соблюдая необходимый формат

### Описание бизнес логики процессов точек доступов, примеры, требования, анализ

#### **Точка доступа для расчёта финальной стоимости продукта - входящие данные, логика, исходящие данные**

##### Входящие данные

```text
POST /calculate-price
{
    "product": 1,
    "taxNumber": "DE123456789",
    "couponCode": "D15"
}
```

1. product - поле, содержащее уникальный идентификатор продукта в проектируемой системе
2. taxNumber - уникальный идентификатор налогоплательщика
3. couponCode - уникальный идентификатор скидки

##### Бизнес логика процесса

* реализовать валидацию всех полей (в том числе корректность tax номера согласно формату) в теле запросов, используя
  Symfony validator
* рассчитать итоговую цену покупки вместе с купоном (если указан) и налогом

---

##### Исходящие данные

В случае успеха:

```text
HTTP/1.1 200 OK
```

В случае ошибки валидации входящих данных:

```text
HTTP/1.1 400 OK
Content-Type: application/json
{
    "field": "product",  // Поле запроса, не прошедшее валидацию
    "error": "not found" // Тестовое описание ошибки
}
```

##### Анализ входящих данных, логики, исходящих данных

###### Анализ входящих данных

```text
    "product": 1,
```

Необходим для получения базовой цены и валюты продукта.

Плюсы:

* Привычно, понятно

Минусы:

* Раскрывает организацию данных для приложения клиента
* Упрощает парсинг данных сторонними сервисами
* Не соответствует идеологии ЧПУ-URL (friendly URL)

На мой взгляд корректно передавать так называемый `slug`.

Slug - уникальный идентификатор продукта в системе, имеющий дружественное текстовое представление.

```text
"product": "iphone",
```

---

```text
"taxNumber": "DE123456789"
```

В этом поле скрыты символы, указывающие на страну покупателя. Необходим для определения налогообложения страны

```text
Формат налогового номера

DEXXXXXXXXX - для жителей Германии,

ITXXXXXXXXXXX - для жителей Италии,

GRXXXXXXXXX - для жителей Греции,

FRYYXXXXXXXXX - для жителей Франции

где:

    первые два символа - это код страны,
    X - любая цифра от 0 до 9,
    Y - любая буква

Обратите внимание, что длина налогового номера разная для разных стран.
Форматы налоговых номеров могут меняться, что случается редко. (Это зависит от законодательства.)
```

Плюсы:

* Нет

Минусы:

* Для расчёта финальной стоимости данные избыточны
* Существенно усложняют логику работы точки доступа
* Добавляют исключительные ситуации

Предложение по оптимизации - заменить поле `taxNumber` на `country` - значениями могут быть коды стран в соответствии
с [международным стандартом для представления названий стран](https://www.iso.org/ru/iso-3166-country-codes.html).

```text
"country": "DE"
```

---

```text
"couponCode": "D15"
```

Уникальный идентификатор скидки, опционален.

Плюсы:

* Понятно, привычно
* Хорошее сокрытие бизнес логики приложения от клиента

Минусы:

* Нет

###### Анализ бизнес логики процесса

Финальная стоимость товара - совокупность базовой стоимости в определённой валюте, скидок и наценок.
В рамках проектируемой системы заложено:

1. Базовая стоимость товара - определённая и необходимая в определённой валюте (EUR)
2. Скидка (Купон) - определённая двумя типами и опциональная
    1. Фиксированная - определённая сумма в определённой валюте
    2. Процент - относительная величина базовой стоимости в валюте базовой стоимости
3. Наценка (Налог) - определённая одним типом и необходимая
    1. Налог на базовую стоимость продукта - определённая системой налогообложения страны покупателя относительная
       величина базовой стоимости в валюте базовой стоимости
4. Продукт (Товар) - определённая и необходимая единица системы с определённой базовой стоимостью и валютой
    1. Iphone (100 EUR) - доступный для расчёта финальной стоимости и продажи
    2. Headphones (20 EUR) - доступный для расчёта финальной стоимости и продажи
    3. Case (10 EUR) - доступный для расчёта финальной стоимости и продажи

Предлагаемый техническим заданием алгоритм расчёта финальной стоимости продукта:

```text
    Базовая стоимость товара с учётом скидок = Базовая стоимость товара - Совокупность скидок (Купон)
    Финальная стоимость =  Базовая стоимость товара с учётом скидок + Совокупность наценок (базовая стоимость товара с учётом скидок)
```

Пример расчёта финальной стоимости товара Iphone без скидки для Греции:

1. Базовая стоимость - 100 EUR
2. Наценка - тип "Налог на базовую стоимость" для страны Греция, "Процент", величина 24

```text
Финальная стоимость = 124 EUR = 100 EUR + (100 EUR * 0.24)
```

Пример расчёта финальной стоимости товара Iphone со скидкой для Греции:

1. Базовая стоимость - 100 EUR
2. Скидка - тип "Процент", величина 6
3. Наценка - тип "Налог на базовую стоимость" для страны Греция, "Процент", величина 24

```text
Финальная стоимость = 116.56 = (100 - 100 * 0.06) + (100 - 100 * 0.06) * 0.24 = (100 - 100 * 0.06) * 1.24
```

Для корректной работы точки доступа не хватает уточнения валюты, в которой необходимо получить финальную стоимость.
Из условий задачи понятно, что четыре определённые страны используют именно EUR, как основную валюту расчёта. Общее
название валюты EURO имеет две единицы изменения - EUR | Cent.

В рамках тестового задания это может быть сознательным упрощением и точка доступа всегда будет рассчитывать финальную
стоимость в Euro | EUR.

В рамках реального технического задания есть необходимость уточнения валюты и её единицы измерения:

```text
"currency": [
   {"code" : "EURO", "measure_unit" : "EUR"}
]
```

###### Анализ исходящих данных

Определён ответ для всех проектируемых точек доступа в случае успешного выполнения бизнес логики:

```text
HTTP/1.1 200 OK
```

Плюсы:

* Нет

Минусы:

* Нет

Вопрос: клиент действительно получит необходимую информацию?

Определён ответ для всех проектируемых точек доступа в случае ошибок выполнения бизнес логики в части валидации входящих
данных:

```text
HTTP/1.1 400 OK
Content-Type: application/json
{
    "field": "product",  // Поле запроса, не прошедшее валидацию
    "error": "not found" // Тестовое описание ошибки
}
```

Плюсы:

* Нет

Минусы:

* Не определён код ответа 404 - продукт не найден. Это не попадает под первичную валидацию запроса.

Вопрос: клиент действительно получит необходимую информацию?

###### Влияние требований к логике точки доступа на проблемную область:

1. Приложение не может рассчитать финальную цену товара с учётом скидок и наценок используя входящие данные точки
   доступа
2. Приложение не может вернуть клиенту ответ об успешном выполнении запроса в необходимом формате
3. Приложение не может вернуть клиенту ответ об ошибке в процессе выполнения запроса соблюдая необходимый формат

#### **Точка доступа для выполнения покупки - входящие данные, логика, исходящие данные**

На основании рассчитанной финальной стоимости товара провести платёж через существующие на проекте платёжные шлюзы.

##### Входящие данные

```text
POST /purchase 
{
    "product": 1,
    "taxNumber": "IT12345678900",
    "couponCode": "D15",
    "paymentProcessor": "paypal"
}
```

1. product - поле, содержащее уникальный идентификатор продукта в проектируемой системе
2. taxNumber - уникальный идентификатор налогоплательщика
3. couponCode - уникальный идентификатор скидки
4. paymentProcessor - тип платёжной системы

##### Бизнес логика процесса

* реализовать валидацию всех полей (в том числе корректность tax номера согласно формату) в теле запросов, используя
  Symfony validator
* рассчитать итоговую цену покупки вместе с купоном (если указан) и налогом
* использовать для проведения платежа PaypalPaymentProcessor::pay() или StripePaymentProcessor::processPayment()

##### Исходящие данные

В случае успеха:

```text
HTTP/1.1 200 OK
```

В случае ошибки валидации входящих данных или проведения платежа:

```text
HTTP/1.1 400 OK
Content-Type: application/json
{
    "field": "product",  // Поле запроса, не прошедшее валидацию
    "error": "not found" // Тестовое описание ошибки
}
```

##### Анализ входящих данных, логики, исходящих данных

###### Анализ входящих данных

```text
POST /purchase 
{
    "product": 1,
    "taxNumber": "IT12345678900",
    "couponCode": "D15",
    "paymentProcessor": "paypal"
}
```

* product - аналитика выше по тексту
* taxNumber - аналитика выше по тексту
* couponCode - аналитика выше по тексту
* paymentProcessor - в проекте определён двумя типами:
    * paypal
        * ограничение по переводу - не более 100000 единиц в наименьшей единице измерения (Cent) определённой валюты (
          EUR)
    * stripe
        * ограничение по переводу - не более 100 единиц в единице измерения (EUR) определённой валюты (EUR)

###### Анализ бизнес логики процесса

* реализовать валидацию всех полей (в том числе корректность tax номера согласно формату) в теле запросов, используя
  Symfony validator

Вопросов нет.

* рассчитать итоговую цену покупки вместе с купоном (если указан) и налогом

В зависимости от выбранного подхода и принятых на проекте практик - вопросов может не возникнуть.

* использовать для проведения платежа PaypalPaymentProcessor::pay() или StripePaymentProcessor::processPayment()

В техническом задании нет описания логики работы при пересечении пограничных значений.
Что делать, если тип платёжного шлюза stripe и финальная стоимость больше ограничения?

* Пытаться выполнить операцию через paypal, где сумму можно провести большую?
* Выкинуть ошибку клиенту сразу?

###### Анализ исходящих данных

Достаточны ли ответы для клиентского приложения?